<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Registro del personal</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='normalize.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style_registro.css') }}" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>


<body>
  <!-- HEADER TromLuc -->
  <header>
    <nav class="top-nav">
      <div class="nav-left">
        <img src="{{ url_for('static', filename='imgs/logo.png') }}" alt="Logo">
      </div>
      <div class="nav-right">
        <a href="{{ url_for('mostrar_registros') }}">
          <button type="button">Tabla Registros</button>
        </a>
        <button onclick="window.location.href='/logout';">Cerrar sesi칩n</button>

      </div>
    </nav>
  </header>
  <!-- Contenedor donde va el formulario de registro principal -->
  <main>
    <div class="form-container">
      <h2 style="text-align:center; margin-bottom: 20px;">Registro de Asistencia TromLuc</h2>

      <form id="formRegistro" method="POST" action="/registrar" enctype="multipart/form-data">
    <!-- Los campos de tu formulario -->
    <label for="nombre">Nombre(s):</label>
    <input type="text" id="nombre" name="nombre" required autocomplete="off" />
    <label for="apellido_paterno">Apellido paterno:</label>
    <input type="text" id="apellido_paterno" name="apellido_paterno" required autocomplete="off" />
    <label for="apellido_materno">Apellido materno:</label>
    <input type="text" id="apellido_materno" name="apellido_materno" required autocomplete="off" />
    <div class="div-labelusuario">
        <label for="tipo_usuario">Departamento</label>
        <select id="tipo_usuario" name="tipo_usuario" required>
            <option value="" disabled selected>Selecciona un tipo</option>
            {% for id_tipo, tipo in tipos %}
            <option value="{{ id_tipo }}">{{ tipo }}</option>
            {% endfor %}
        </select>
    </div>

 <!--AQUI VA LA CAMARA PARA EL REGISTRO-->
    <label>Foto:</label>
    <button type="button" id="abrirCamaraBtn">Abrir c치mara</button>
    <video id="video" autoplay playsinline style="display:none;"></video>
    <button type="button" id="tomarFoto" style="display:none; margin-top:10px;">Tomar Foto</button>
    <canvas id="canvas" style="display:none;"></canvas>

    <input type="hidden" name="foto" id="fotoInput" />
    <input type="submit" value="Registrar" />
</form>

<!-- Modal de Respuesta -->


<!-- Modal de Respuesta (Por defecto est치 oculto PERO se debe editar el dise침o) -->
<div id="respuestaModal" style="display:none; background-color: rgba(0, 0, 0, 0.5); position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 9999; justify-content: center; align-items: center;">
    <div style="background-color: white; padding: 20px; border-radius: 10px; width: 80%; max-width: 500px; text-align: center;">
        <h3 id="respuestaMensaje"></h3>
        <button onclick="cerrarModal()">Cerrar</button>
    </div>
</div>

<!-- Coloca aqu칤 los mensajes  Flask, pero ocultos -->
<div id="mensajeFlash" style="display:none;">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {{ messages[0][1] }} <!-- El mensaje que se pasar치 al JavaScript -->
        {% endif %}
    {% endwith %}
</div>


<script>
    // SCRIPT PARA LA MUESTRA DEL MODAL
    document.addEventListener('DOMContentLoaded', function () {
        const mensajeFlash = document.getElementById('mensajeFlash').innerText.trim();
        
        
        if (mensajeFlash) {
            // Mostrar el modal
            document.getElementById('respuestaModal').style.display = 'flex';
            document.getElementById('respuestaMensaje').innerText = mensajeFlash;

            // Cerrar el modal autom치ticamente despu칠s de 10 segundos aqui podemos editar 
            setTimeout(() => {
                document.getElementById('respuestaModal').style.display = 'none';
            }, 10000);  // 10000 ms = 10 segundos 
        }
    });

    // Funci칩n para cerrar el modal manualmente PODEMOS quitarlo pero se ve mejor cerrandolo (opinion mia xd)
    function cerrarModal() {
        document.getElementById('respuestaModal').style.display = 'none';
    }
</script>




<script>
    // El c칩digo para abrir la c치mara y tomar la foto se mantiene igual que antes
    const abrirCamaraBtn = document.getElementById('abrirCamaraBtn');
    const video = document.getElementById('video');
    const tomarFotoBtn = document.getElementById('tomarFoto');
    const canvas = document.getElementById('canvas');
    const fotoInput = document.getElementById('fotoInput');
    let stream;

    abrirCamaraBtn.addEventListener('click', async () => {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            video.style.display = 'block';
            tomarFotoBtn.style.display = 'inline-block';
            abrirCamaraBtn.style.display = 'none';
        } catch (err) {
            alert("No se pudo acceder a la c치mara: " + err);
        }
    });

    tomarFotoBtn.addEventListener('click', () => {
        const contexto = canvas.getContext('2d');
        const width = 320;
        const height = 240;
        canvas.width = width;
        canvas.height = height;

        contexto.drawImage(video, 0, 0, width, height);
        const dataURL = canvas.toDataURL('image/jpeg', 0.6);

        // Redimensionar la imagen antes de asignarla al input
        const img = new Image();
        img.src = dataURL;
        img.onload = function () {
            const maxWidth = 800;  // Ancho m치ximo de la imagen
            const maxHeight = 600; // Alto m치ximo de la imagen

            let newWidth = img.width;
            let newHeight = img.height;

            // Redimensionar la imagen si es m치s grande que el m치ximo permitido
            if (newWidth > maxWidth || newHeight > maxHeight) {
                const ratio = Math.min(maxWidth / newWidth, maxHeight / newHeight);
                newWidth = newWidth * ratio;
                newHeight = newHeight * ratio;
            }

            // Crear un nuevo canvas para redibujar la imagen redimensionada
            const resizedCanvas = document.createElement('canvas');
            const resizedContext = resizedCanvas.getContext('2d');
            resizedCanvas.width = newWidth;
            resizedCanvas.height = newHeight;

            resizedContext.drawImage(img, 0, 0, newWidth, newHeight);

            // Obtener la imagen redimensionada en base64
            const resizedDataURL = resizedCanvas.toDataURL('image/jpeg', 0.6);
            fotoInput.value = resizedDataURL;

            alert("游닞 Foto capturada y redimensionada. Ahora env칤a el formulario.");

            stream.getTracks().forEach(track => track.stop());
            video.style.display = 'none';
            tomarFotoBtn.style.display = 'none';
            abrirCamaraBtn.style.display = 'inline-block';
        };
    });
</script>



</body>

</html>